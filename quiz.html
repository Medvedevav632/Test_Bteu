<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f4f6fa;
  color: #333;
  line-height: 1.6;
}

.header {
  background: #1a3a5c;
  color: #fff;
  padding: 20px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: relative;
}

.header .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
.header h1 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
.header p  { font-size: 14px; opacity: 0.9; }

.secret-btn {
  position: absolute;
  top: 50%; right: 20px;
  transform: translateY(-50%);
  width: 40px; height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.3);
  cursor: pointer;
  transition: all 0.3s;
}
.secret-btn:hover { background: rgba(255,255,255,0.2); }

.container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }

.info-block {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.info-block h2 { font-size: 18px; margin-bottom: 15px; color: #1a3a5c; }

.form-row { display: flex; gap: 15px; margin-bottom: 15px; }
.form-group { flex: 1; }
.form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #555; }
.form-group input,
.form-group select {
  width: 100%; padding: 10px;
  border: 1px solid #ddd; border-radius: 4px; font-size: 14px;
}

.progress-bar {
  background: #fff; border-radius: 8px;
  padding: 15px 20px; margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.progress-bar-inner { background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; }
.progress-bar-fill  { background: #1a3a5c; height: 100%; transition: width 0.3s; }
.progress-text { margin-top: 8px; font-size: 13px; color: #666; }

.question-card {
  background: #fff;
  border-radius: 8px;
  padding: 25px;
  margin-bottom: 20px;
  border-left: 4px solid #1a3a5c;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: border-color 0.3s;
}
.question-card.q-correct  { border-left-color: #28a745; }
.question-card.q-incorrect { border-left-color: #dc3545; }

.question-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
.question-number {
  font-size: 14px; font-weight: 600; color: #1a3a5c;
  background: #e8f0f8; padding: 4px 10px; border-radius: 4px;
}
.question-weight { font-size: 13px; color: #666; }
.question-text   { font-size: 16px; margin-bottom: 20px; line-height: 1.6; }

.options { display: flex; flex-direction: column; gap: 10px; }
.option {
  padding: 12px; border: 2px solid #e0e0e0;
  border-radius: 6px; cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 10px;
}
.option:hover { border-color: #1a3a5c; background: #f8f9fb; }
.option input[type="radio"],
.option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.option-text { flex: 1; font-size: 15px; }
.option.selected  { border-color: #1a3a5c; background: #e8f0f8; }
.option.correct   { border-color: #28a745 !important; background: #d4edda !important; }
.option.incorrect { border-color: #dc3545 !important; background: #f8d7da !important; }

/* Matching */
.matching-container { display: flex; flex-direction: column; gap: 12px; }
.matching-pair { display: flex; align-items: center; gap: 15px; }
.matching-left {
  flex: 1; padding: 10px 15px;
  background: #e8f0f8; border-radius: 6px; font-weight: 500;
}
.matching-right { flex: 1; }
.matching-right select {
  width: 100%; padding: 10px;
  border: 2px solid #e0e0e0; border-radius: 6px;
  font-size: 14px; cursor: pointer;
}
.matching-right select.matched { border-color: #1a3a5c; }

/* Ordering */
.ordering-container { display: flex; flex-direction: column; gap: 8px; }
.ordering-item {
  padding: 12px 15px;
  background: #f8f9fb;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: move;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 10px;
  user-select: none;
}
.ordering-item:hover { border-color: #1a3a5c; }
.ordering-item.dragging { opacity: 0.4; }
.ordering-item.drag-over { border-color: #1a3a5c; background: #e8f0f8; }
.drag-handle { font-size: 18px; color: #999; }

/* FillIn */
.fillin-template { font-size: 15px; line-height: 2.2; }
.fillin-input {
  display: inline-block;
  padding: 4px 10px;
  border: none; border-bottom: 2px solid #1a3a5c;
  background: transparent;
  font-size: 15px;
  min-width: 120px;
  text-align: center;
  font-family: inherit;
}

/* Numeric */
.numeric-input-container { display: flex; align-items: center; gap: 10px; max-width: 300px; }
.numeric-input-container input {
  flex: 1; padding: 10px;
  border: 2px solid #e0e0e0; border-radius: 6px; font-size: 15px;
}
.numeric-unit { font-weight: 500; color: #666; }

/* Essay */
.essay-textarea {
  width: 100%; min-height: 150px;
  padding: 12px;
  border: 2px solid #e0e0e0; border-radius: 6px;
  font-family: inherit; font-size: 14px; resize: vertical;
}
.char-counter { text-align: right; font-size: 12px; color: #999; margin-top: 5px; }

.submit-section { text-align: center; margin: 30px 0; }
.submit-btn {
  background: #1a3a5c; color: #fff;
  border: none; padding: 15px 50px;
  border-radius: 8px; font-size: 16px; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 4px 8px rgba(26,58,92,0.2);
}
.submit-btn:hover { background: #2c5278; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(26,58,92,0.3); }
.submit-btn:disabled { background: #999; transform: none; box-shadow: none; cursor: not-allowed; }

/* Result */
.result-block {
  background: #fff; border-radius: 8px;
  padding: 40px; text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
}
.result-score  { font-size: 48px; font-weight: 700; color: #1a3a5c; margin-bottom: 5px; }
.result-correct { font-size: 0.9rem; color: #666; font-weight: 400; margin-bottom: 12px; }
.result-grade {
  display: inline-block; padding: 10px 30px;
  border-radius: 6px; font-size: 20px; font-weight: 600; margin: 20px 0;
}
.grade-10, .grade-9 { background: #d4edda; color: #155724; }
.grade-8,  .grade-7 { background: #d1ecf1; color: #0c5460; }
.grade-6,  .grade-5 { background: #fff3cd; color: #856404; }
.grade-4, .grade-3, .grade-2, .grade-1 { background: #f8d7da; color: #721c24; }

.result-status { margin-top: 20px; padding: 15px; background: #e8f0f8; border-radius: 6px; font-size: 14px; }

.retry-btn {
  margin-top: 25px;
  background: #fff; color: #1a3a5c;
  border: 2px solid #1a3a5c; padding: 12px 40px;
  border-radius: 6px; font-size: 15px; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
}
.retry-btn:hover { background: #1a3a5c; color: #fff; }

.loading { text-align: center; padding: 40px; font-size: 16px; color: #666; }

.polling-msg { margin-top: 15px; font-size: 14px; color: #666; }

@media (max-width: 768px) {
  .header h1 { font-size: 20px; }
  .form-row { flex-direction: column; }
  .question-card { padding: 20px 15px; }
  .result-score { font-size: 36px; }
  .matching-pair { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<div class="header">
  <div class="container">
    <h1 id="test-title">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å ‚Äî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
    <p id="test-description"></p>
  </div>
  <button class="secret-btn" onclick="promptPassword()" title=""></button>
</div>

<div class="container">
  <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞‚Ä¶</div>

  <div id="test-container" style="display:none;">
    <div class="info-block">
      <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="student-name">–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞</label>
          <select id="student-name">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
            <option>–ê—à–∏—Ä–æ–≤ –ê—Ä—Ç—ë–º</option>
            <option>–ë–∞–Ω–Ω–∞—è –ê–Ω–∞—Å—Ç–∞—Å–∏—è</option>
            <option>–ë–æ–±—Ä–æ–≤ –ú–∞–∫—Å–∏–º</option>
            <option>–ë–æ—Ä–æ—à–µ–≤—Å–∫–∞—è –Æ–ª–∏—è</option>
            <option>–ì–∞–±–µ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞</option>
            <option>–î–µ–º—å—è–Ω—Ü–µ–≤ –Ø—Ä–æ—Å–ª–∞–≤</option>
            <option>–ö–æ–ª—è–¥–∞ –ê–Ω–¥—Ä–µ–π</option>
            <option>–ö—É—Ü–µ–Ω–∫–æ–≤ –î–µ–Ω–∏—Å</option>
            <option>–ü–∞–Ω–∫—Ä–∞—Ç –ù–∏–∫–∏—Ç–∞</option>
            <option>–ü—Ä–æ–∫–æ–ø—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤</option>
            <option>–°–µ—Ä–¥—é–∫–æ–≤ –ê—Ä—Ç—É—Ä</option>
            <option>–¢–∞–ª–∞–Ω—Ü–µ–≤–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞</option>
            <option>–¢–∏—Ç–µ–Ω–∫–æ–≤ –ê—Ä—Ç—ë–º</option>
            <option>–¢–∏—à–∫–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤</option>
            <option>–ß—É–π–∫–æ–≤–∞ –î–∞—Ä—å—è</option>
            <option>–®—É–±–µ–Ω–æ–∫ –°–µ—Ä–≥–µ–π</option>
            <option>–ì–æ—Å—Ç—å</option>
          </select>
        </div>
        <div class="form-group">
          <label for="student-group">–ì—Ä—É–ø–ø–∞</label>
          <input type="text" id="student-group" value="–ê-31">
        </div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-bar-inner">
        <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
      </div>
      <div class="progress-text" id="progress-text">–û—Ç–≤–µ—á–µ–Ω–æ: 0 –∏–∑ 0</div>
    </div>

    <div class="submit-section">
      <button class="submit-btn" id="submit-top" onclick="submitTest()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>

    <div id="questions-container"></div>

    <div class="submit-section">
      <button class="submit-btn" id="submit-bottom" onclick="submitTest()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>
  </div>

  <div class="result-block" id="result-block">
    <div class="result-score"  id="result-score"></div>
    <div class="result-correct" id="result-correct"></div>
    <div class="result-grade"  id="result-grade"></div>
    <div class="result-status" id="result-status"></div>
    <button class="retry-btn" onclick="location.reload()">–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
  </div>
</div>

<script>
// BUG FIX #1: –ë—ã–ª —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π URL —Å–∫—Ä–∏–ø—Ç–∞ (–¥—Ä—É–≥–æ–π scriptId)
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8pRDPblZGCAOENV2fNsxDQRMZ4z6ZJmVTFZkRhkCs1B0cS7RkWZHbirlrMfSfDn5lFA/exec';
const TEACHER_PASSWORD = '1945';

let testData    = null;
let questions   = [];
let answers     = {};
let startTime   = null;
let showAnswersMode = false;
let serverResults   = null;

// ‚îÄ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getTestId() {
  return new URLSearchParams(window.location.search).get('test') || 'Tema1';
}

async function loadTest() {
  const testId = getTestId();
  try {
    const resp = await fetch(`${APPS_SCRIPT_URL}?mode=getQuestions&testId=${testId}`);
    const data = await resp.json();

    if (data.error) {
      document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
      return;
    }

    testData  = data.config;
    questions = data.questions;

    document.getElementById('test-title').textContent = testData.title;
    document.getElementById('test-description').textContent = testData.description || '';

    renderQuestions();
    updateProgress();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('test-container').style.display = 'block';

    startTime = Date.now();
  } catch (err) {
    document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + err.message;
  }
}

// ‚îÄ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderQuestions() {
  const container = document.getElementById('questions-container');
  container.innerHTML = '';

  questions.forEach((q, index) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.id = `q-${q.id}`;

    const w = q.weight;
    const wLabel = w === 1 ? '–±–∞–ª–ª' : (w >= 2 && w <= 4 ? '–±–∞–ª–ª–∞' : '–±–∞–ª–ª–æ–≤');
    card.innerHTML = `
      <div class="question-header">
        <span class="question-number">–í–æ–ø—Ä–æ—Å ${index + 1}</span>
        <span class="question-weight">${w} ${wLabel}</span>
      </div>
      <div class="question-text">${q.text}</div>
    `;

    const renderFn = {
      single:    () => renderSingle(q),
      multi:     () => renderMulti(q),
      truefalse: () => renderTrueFalse(q),
      matching:  () => renderMatching(q),
      ordering:  () => renderOrdering(q),
      fillin:    () => renderFillIn(q),
      numeric:   () => renderNumeric(q),
      essay:     () => renderEssay(q)
    }[q.type];

    if (renderFn) card.innerHTML += renderFn();

    container.appendChild(card);

    if (q.type === 'ordering') {
      setTimeout(() => setupDragDrop(q.id), 0);
    }
  });
}

function renderSingle(q) {
  return '<div class="options">' + q.options.map((opt, idx) => `
    <label class="option" onclick="selectSingle('${q.id}', ${idx}, this)">
      <input type="radio" name="q-${q.id}" value="${idx}" onchange="updateProgress()">
      <span class="option-text">${opt}</span>
    </label>
  `).join('') + '</div>';
}

function renderMulti(q) {
  return '<div class="options">' + q.options.map((opt, idx) => `
    <label class="option" onclick="toggleMultiLabel(this)">
      <input type="checkbox" class="q-${q.id}" value="${idx}" onchange="saveMulti('${q.id}'); updateProgress()">
      <span class="option-text">${opt}</span>
    </label>
  `).join('') + '</div>';
}

function renderTrueFalse(q) {
  return `
    <div class="options">
      <label class="option" onclick="selectSingle('${q.id}', 'true', this)">
        <input type="radio" name="q-${q.id}" value="true" onchange="updateProgress()">
        <span class="option-text">–í–µ—Ä–Ω–æ</span>
      </label>
      <label class="option" onclick="selectSingle('${q.id}', 'false', this)">
        <input type="radio" name="q-${q.id}" value="false" onchange="updateProgress()">
        <span class="option-text">–ù–µ–≤–µ—Ä–Ω–æ</span>
      </label>
    </div>`;
}

// BUG FIX #2: –°–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç q.left[] –∏ q.rightOptions[], –∞ –Ω–µ q.pairs[].
// –°—Ç–∞—Ä—ã–π –∫–æ–¥ –æ–±—Ä–∞—â–∞–ª—Å—è –∫ q.pairs.map(...) ‚Üí TypeError, matching –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–ª—Å—è.
function renderMatching(q) {
  const lefts   = Array.isArray(q.left)         ? q.left         : [];
  const rights  = Array.isArray(q.rightOptions) ? q.rightOptions : [];

  return '<div class="matching-container">' + lefts.map((left, idx) => `
    <div class="matching-pair">
      <div class="matching-left">${left}</div>
      <div class="matching-right">
        <select onchange="saveMatching('${q.id}', '${left.replace(/'/g,"\\'")}', this.value); updateProgress()"
                class="matching-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
          ${rights.map(r => `<option value="${r}">${r}</option>`).join('')}
        </select>
      </div>
    </div>
  `).join('') + '</div>';
}

function renderOrdering(q) {
  return `<div class="ordering-container" id="ordering-${q.id}">` +
    q.items.map((item, idx) => `
      <div class="ordering-item" draggable="true" data-index="${idx}">
        <span class="drag-handle">‚ò∞</span>
        <span>${item}</span>
      </div>
    `).join('') +
  '</div>';
}

function renderFillIn(q) {
  let template = q.template;
  for (let i = 0; i < q.blanksCount; i++) {
    template = template.replace('[BLANK]',
      `<input type="text" class="fillin-input" data-qid="${q.id}" data-blank="${i}"
       oninput="saveFillIn('${q.id}'); updateProgress()">`);
  }
  return `<div class="fillin-template">${template}</div>`;
}

function renderNumeric(q) {
  return `
    <div class="numeric-input-container">
      <input type="number" step="any" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ"
        oninput="saveNumeric('${q.id}', this.value); updateProgress()">
      <span class="numeric-unit">${q.unit || ''}</span>
    </div>`;
}

function renderEssay(q) {
  return `
    <textarea class="essay-textarea" maxlength="${q.maxLength || 600}"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç‚Ä¶"
      oninput="saveEssay('${q.id}', this.value); updateCharCount('${q.id}', this.value.length, ${q.maxLength || 600}); updateProgress()">
    </textarea>
    <div class="char-counter" id="char-count-${q.id}">0 / ${q.maxLength || 600}</div>
    ${q.rubric ? `<div style="margin-top:10px;font-size:13px;color:#666;">–ö—Ä–∏—Ç–µ—Ä–∏–∏: ${q.rubric}</div>` : ''}`;
}

// ‚îÄ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function selectSingle(qid, value, labelEl) {
  answers[qid] = value;
  document.querySelectorAll(`[name="q-${qid}"]`).forEach(inp => {
    inp.closest('.option').classList.remove('selected');
  });
  if (labelEl) labelEl.classList.add('selected');
}

function toggleMultiLabel(labelEl) {
  setTimeout(() => {
    const cb = labelEl.querySelector('input[type="checkbox"]');
    if (cb && cb.checked) labelEl.classList.add('selected');
    else labelEl.classList.remove('selected');
  }, 0);
}

function saveMulti(qid) {
  const checked = Array.from(document.querySelectorAll(`.q-${qid}:checked`)).map(cb => parseInt(cb.value));
  answers[qid] = checked.length > 0 ? checked : undefined;
}

function saveMatching(qid, left, right) {
  if (!answers[qid]) answers[qid] = {};
  if (right) answers[qid][left] = right;
  else delete answers[qid][left];
}

function saveFillIn(qid) {
  const inputs = document.querySelectorAll(`input[data-qid="${qid}"]`);
  const blanks = Array.from(inputs).map(inp => inp.value.trim());
  answers[qid] = blanks.some(b => b !== '') ? blanks : undefined;
}

function saveNumeric(qid, value) {
  answers[qid] = value !== '' ? value : undefined;
}

function saveEssay(qid, value) {
  answers[qid] = value.trim() !== '' ? value.trim() : undefined;
}

function updateCharCount(qid, length, max) {
  const el = document.getElementById(`char-count-${qid}`);
  if (el) el.textContent = `${length} / ${max}`;
}

// ‚îÄ‚îÄ‚îÄ Drag-and-drop –¥–ª—è ordering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setupDragDrop(qid) {
  const container = document.getElementById(`ordering-${qid}`);
  if (!container) return;
  let draggedItem = null;

  container.addEventListener('dragstart', e => {
    draggedItem = e.target.closest('.ordering-item');
    if (draggedItem) setTimeout(() => draggedItem.classList.add('dragging'), 0);
  });

  container.addEventListener('dragend', e => {
    if (draggedItem) draggedItem.classList.remove('dragging');
    container.querySelectorAll('.ordering-item').forEach(el => el.classList.remove('drag-over'));
    draggedItem = null;
    saveOrdering(qid);
    updateProgress();
  });

  container.addEventListener('dragover', e => {
    e.preventDefault();
    const target = e.target.closest('.ordering-item');
    if (!target || target === draggedItem) return;
    container.querySelectorAll('.ordering-item').forEach(el => el.classList.remove('drag-over'));
    target.classList.add('drag-over');
    const rect = target.getBoundingClientRect();
    const isBefore = e.clientY < rect.top + rect.height / 2;
    container.insertBefore(draggedItem, isBefore ? target : target.nextSibling);
  });

  container.addEventListener('drop', e => e.preventDefault());
}

function saveOrdering(qid) {
  const container = document.getElementById(`ordering-${qid}`);
  if (!container) return;
  const order = Array.from(container.querySelectorAll('.ordering-item')).map(el => parseInt(el.dataset.index));
  answers[qid] = order;
}

// ‚îÄ‚îÄ‚îÄ –ü—Ä–æ–≥—Ä–µ—Å—Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateProgress() {
  const answered = Object.keys(answers).filter(k => {
    const v = answers[k];
    if (v === undefined || v === null || v === '') return false;
    if (Array.isArray(v)) return v.length > 0;
    if (typeof v === 'object') return Object.keys(v).length > 0;
    return true;
  }).length;

  const total = questions.length;
  const pct   = total > 0 ? (answered / total) * 100 : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent  = `–û—Ç–≤–µ—á–µ–Ω–æ: ${answered} –∏–∑ ${total}`;
}

// ‚îÄ‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function submitTest() {
  const fio   = document.getElementById('student-name').value;
  const group = document.getElementById('student-group').value;

  if (!fio)   { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –§–ò–û –∏–∑ —Å–ø–∏—Å–∫–∞'); return; }
  if (!group) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≥—Ä—É–ø–ø—É'); return; }

  const answeredCount = Object.keys(answers).filter(k => {
    const v = answers[k];
    if (v === undefined || v === null || v === '') return false;
    if (Array.isArray(v)) return v.length > 0;
    if (typeof v === 'object') return Object.keys(v).length > 0;
    return true;
  }).length;

  const unansweredCount = questions.length - answeredCount;
  if (unansweredCount > 0) {
    if (!confirm(`–í—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ ${unansweredCount} –≤–æ–ø—Ä. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?`)) return;
  }

  const duration = Math.floor((Date.now() - startTime) / 1000);

  const payload = {
    testId:   testData.testId,
    fio, group,
    attempt:  1,
    duration,
    answers
  };

  setSubmitBtns(true);
  showSendingMsg('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤‚Ä¶ ‚è≥');

  try {
    const url  = APPS_SCRIPT_URL + '?mode=submit&data=' + encodeURIComponent(JSON.stringify(payload));
    const resp = await fetch(url);
    const result = await resp.json();

    hideSendingMsg();

    if (result.error) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + result.error);
      setSubmitBtns(false);
      return;
    }

    serverResults = result;
    showResults(result);

  } catch (err) {
    hideSendingMsg();
    setSubmitBtns(false);
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
  }
}

function setSubmitBtns(disabled) {
  document.getElementById('submit-top').disabled    = disabled;
  document.getElementById('submit-bottom').disabled = disabled;
}

function showSendingMsg(msg) {
  let el = document.getElementById('sending-msg');
  if (!el) {
    el = document.createElement('div');
    el.id = 'sending-msg';
    el.style.cssText = 'text-align:center;margin-top:12px;color:#666;font-size:14px;';
    document.getElementById('submit-bottom').insertAdjacentElement('afterend', el);
  }
  el.textContent = msg;
}

function hideSendingMsg() {
  const el = document.getElementById('sending-msg');
  if (el) el.remove();
}

// ‚îÄ‚îÄ‚îÄ –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showResults(result) {
  document.getElementById('test-container').style.display = 'none';

  const rb = document.getElementById('result-block');
  rb.style.display = 'block';

  document.getElementById('result-score').textContent =
    `${Number(result.scoreWeighted).toFixed(1)} / ${result.maxWeight}`;

  document.getElementById('result-correct').textContent =
    `(–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: ${result.correctCount} –∏–∑ ${result.totalCount || questions.length})`;

  const gradeDiv = document.getElementById('result-grade');
  gradeDiv.textContent = `–û—Ü–µ–Ω–∫–∞: ${result.score10}`;
  gradeDiv.className   = 'result-grade grade-' + result.score10;

  let statusHtml = '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é';
  if (result.unanswered > 0)       statusHtml += `<br>‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${result.unanswered}`;
  if (result.needsManualGrade)     statusHtml += `<br>üìù –ß–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏`;

  document.getElementById('result-status').innerHTML = statusHtml;
}

// ‚îÄ‚îÄ‚îÄ –†–µ–∂–∏–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è (–ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function promptPassword() {
  if (showAnswersMode) {
    showAnswersMode = false;
    clearHighlight();
    return;
  }
  const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:');
  if (pwd === TEACHER_PASSWORD) {
    if (!serverResults) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç'); return; }
    showAnswersMode = true;
    highlightAnswers();
  } else if (pwd !== null) {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
  }
}

function highlightAnswers() {
  if (!serverResults || !serverResults.details) return;

  serverResults.details.forEach(detail => {
    const card = document.getElementById(`q-${detail.qId}`);
    if (!card) return;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ü–µ–ª–∏–∫–æ–º
    card.classList.add(detail.correct ? 'q-correct' : 'q-incorrect');

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è single / multi / truefalse
    const opts = card.querySelectorAll('.option');
    opts.forEach(opt => {
      const inp = opt.querySelector('input');
      if (!inp) return;
      if (!inp.checked) return;
      opt.classList.add(detail.correct ? 'correct' : 'incorrect');
    });

    // –î–ª—è matching ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å selects
    const selects = card.querySelectorAll('.matching-select');
    selects.forEach(sel => {
      if (sel.value) sel.style.borderColor = detail.correct ? '#28a745' : '#dc3545';
    });
  });
}

function clearHighlight() {
  document.querySelectorAll('.question-card').forEach(c => {
    c.classList.remove('q-correct', 'q-incorrect');
  });
  document.querySelectorAll('.option').forEach(o => {
    o.classList.remove('correct', 'incorrect');
  });
  document.querySelectorAll('.matching-select').forEach(s => {
    s.style.borderColor = '';
  });
}

window.addEventListener('load', loadTest);
</script>
</body>
</html>
