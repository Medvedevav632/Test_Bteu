<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f4f6fa;
  color: #333;
  line-height: 1.6;
}

.header {
  background: #1a3a5c;
  color: #fff;
  padding: 20px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: relative;
}

.header .container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 20px;
}

.header h1 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 5px;
}

.header p {
  font-size: 14px;
  opacity: 0.9;
}

.secret-btn {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.3);
  cursor: pointer;
  transition: all 0.3s;
}

.secret-btn:hover {
  background: rgba(255,255,255,0.2);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 30px 20px;
}

.info-block {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.info-block h2 {
  font-size: 18px;
  margin-bottom: 15px;
  color: #1a3a5c;
}

.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}

.form-group {
  flex: 1;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-size: 14px;
  font-weight: 500;
  color: #555;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.progress-bar {
  background: #fff;
  border-radius: 8px;
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.progress-bar-inner {
  background: #e0e0e0;
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar-fill {
  background: #1a3a5c;
  height: 100%;
  transition: width 0.3s;
}

.progress-text {
  margin-top: 8px;
  font-size: 13px;
  color: #666;
}

.question-card {
  background: #fff;
  border-radius: 8px;
  padding: 25px;
  margin-bottom: 20px;
  border-left: 4px solid #1a3a5c;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 15px;
}

.question-number {
  font-size: 14px;
  font-weight: 600;
  color: #1a3a5c;
  background: #e8f0f8;
  padding: 4px 10px;
  border-radius: 4px;
}

.question-weight {
  font-size: 13px;
  color: #666;
}

.question-text {
  font-size: 16px;
  margin-bottom: 20px;
  line-height: 1.6;
}

.options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.option {
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.option:hover {
  border-color: #1a3a5c;
  background: #f8f9fb;
}

.option input[type="radio"],
.option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.option-text {
  flex: 1;
  font-size: 15px;
}

.option.selected {
  border-color: #1a3a5c;
  background: #e8f0f8;
}

.option.correct {
  border-color: #28a745;
  background: #d4edda;
}

.option.incorrect {
  border-color: #dc3545;
  background: #f8d7da;
}

.matching-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.matching-pair {
  display: flex;
  align-items: center;
  gap: 15px;
}

.matching-left {
  flex: 1;
  padding: 10px 15px;
  background: #e8f0f8;
  border-radius: 6px;
  font-weight: 500;
}

.matching-right select {
  flex: 1;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}

.ordering-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.ordering-item {
  padding: 12px 15px;
  background: #f8f9fb;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: move;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.ordering-item:hover {
  border-color: #1a3a5c;
}

.drag-handle {
  font-size: 18px;
  color: #999;
}

.fillin-template {
  font-size: 15px;
  line-height: 2;
}

.fillin-input {
  display: inline-block;
  padding: 4px 10px;
  border: none;
  border-bottom: 2px solid #1a3a5c;
  background: transparent;
  font-size: 15px;
  min-width: 120px;
  text-align: center;
}

.numeric-input-container {
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 300px;
}

.numeric-input-container input {
  flex: 1;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 15px;
}

.numeric-unit {
  font-weight: 500;
  color: #666;
}

.essay-textarea {
  width: 100%;
  min-height: 150px;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical;
}

.char-counter {
  text-align: right;
  font-size: 12px;
  color: #999;
  margin-top: 5px;
}

.submit-section {
  text-align: center;
  margin: 30px 0;
}

.submit-btn {
  background: #1a3a5c;
  color: #fff;
  border: none;
  padding: 15px 50px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 8px rgba(26,58,92,0.2);
}

.submit-btn:hover {
  background: #2c5278;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(26,58,92,0.3);
}

.result-block {
  background: #fff;
  border-radius: 8px;
  padding: 40px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
}

.result-score {
  font-size: 48px;
  font-weight: 700;
  color: #1a3a5c;
  margin-bottom: 5px;
}

.result-correct {
  font-size: 0.9rem;
  color: #666;
  font-weight: 400;
  margin-bottom: 12px;
}

.result-grade {
  display: inline-block;
  padding: 10px 30px;
  border-radius: 6px;
  font-size: 20px;
  font-weight: 600;
  margin: 20px 0;
}

.grade-10, .grade-9 {
  background: #d4edda;
  color: #155724;
}

.grade-8, .grade-7 {
  background: #d1ecf1;
  color: #0c5460;
}

.grade-6, .grade-5 {
  background: #fff3cd;
  color: #856404;
}

.grade-4, .grade-3, .grade-2, .grade-1 {
  background: #f8d7da;
  color: #721c24;
}

.result-status {
  margin-top: 20px;
  padding: 15px;
  background: #e8f0f8;
  border-radius: 6px;
  font-size: 14px;
}

.retry-btn {
  margin-top: 25px;
  background: #fff;
  color: #1a3a5c;
  border: 2px solid #1a3a5c;
  padding: 12px 40px;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.retry-btn:hover {
  background: #1a3a5c;
  color: #fff;
}

.loading {
  text-align: center;
  padding: 40px;
  font-size: 16px;
  color: #666;
}

@media (max-width: 768px) {
  .header h1 {
    font-size: 20px;
  }
  
  .form-row {
    flex-direction: column;
  }
  
  .question-card {
    padding: 20px 15px;
  }
  
  .result-score {
    font-size: 36px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="container">
    <h1 id="test-title">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
    <p id="test-description"></p>
  </div>
  <button class="secret-btn" onclick="promptPassword()"></button>
</div>

<div class="container">
  <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞...</div>
  
  <div id="test-container" style="display:none;">
    <div class="info-block">
      <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="student-name">–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞</label>
          <select id="student-name">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
            <option value="–ê—à–∏—Ä–æ–≤ –ê—Ä—Ç—ë–º">–ê—à–∏—Ä–æ–≤ –ê—Ä—Ç—ë–º</option>
            <option value="–ë–∞–Ω–Ω–∞—è –ê–Ω–∞—Å—Ç–∞—Å–∏—è">–ë–∞–Ω–Ω–∞—è –ê–Ω–∞—Å—Ç–∞—Å–∏—è</option>
            <option value="–ë–æ–±—Ä–æ–≤ –ú–∞–∫—Å–∏–º">–ë–æ–±—Ä–æ–≤ –ú–∞–∫—Å–∏–º</option>
            <option value="–ë–æ—Ä–æ—à–µ–≤—Å–∫–∞—è –Æ–ª–∏—è">–ë–æ—Ä–æ—à–µ–≤—Å–∫–∞—è –Æ–ª–∏—è</option>
            <option value="–ì–∞–±–µ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞">–ì–∞–±–µ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞</option>
            <option value="–î–µ–º—å—è–Ω—Ü–µ–≤ –Ø—Ä–æ—Å–ª–∞–≤">–î–µ–º—å—è–Ω—Ü–µ–≤ –Ø—Ä–æ—Å–ª–∞–≤</option>
            <option value="–ö–æ–ª—è–¥–∞ –ê–Ω–¥—Ä–µ–π">–ö–æ–ª—è–¥–∞ –ê–Ω–¥—Ä–µ–π</option>
            <option value="–ö—É—Ü–µ–Ω–∫–æ–≤ –î–µ–Ω–∏—Å">–ö—É—Ü–µ–Ω–∫–æ–≤ –î–µ–Ω–∏—Å</option>
            <option value="–ü–∞–Ω–∫—Ä–∞—Ç –ù–∏–∫–∏—Ç–∞">–ü–∞–Ω–∫—Ä–∞—Ç –ù–∏–∫–∏—Ç–∞</option>
            <option value="–ü—Ä–æ–∫–æ–ø—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤">–ü—Ä–æ–∫–æ–ø—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤</option>
            <option value="–°–µ—Ä–¥—é–∫–æ–≤ –ê—Ä—Ç—É—Ä">–°–µ—Ä–¥—é–∫–æ–≤ –ê—Ä—Ç—É—Ä</option>
            <option value="–¢–∞–ª–∞–Ω—Ü–µ–≤–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞">–¢–∞–ª–∞–Ω—Ü–µ–≤–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞</option>
            <option value="–¢–∏—Ç–µ–Ω–∫–æ–≤ –ê—Ä—Ç—ë–º">–¢–∏—Ç–µ–Ω–∫–æ–≤ –ê—Ä—Ç—ë–º</option>
            <option value="–¢–∏—à–∫–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤">–¢–∏—à–∫–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤</option>
            <option value="–ß—É–π–∫–æ–≤–∞ –î–∞—Ä—å—è">–ß—É–π–∫–æ–≤–∞ –î–∞—Ä—å—è</option>
            <option value="–®—É–±–µ–Ω–æ–∫ –°–µ—Ä–≥–µ–π">–®—É–±–µ–Ω–æ–∫ –°–µ—Ä–≥–µ–π</option>
            <option value="–ì–æ—Å—Ç—å">–ì–æ—Å—Ç—å</option>
          </select>
        </div>
        <div class="form-group">
          <label for="student-group">–ì—Ä—É–ø–ø–∞</label>
          <input type="text" id="student-group" value="–ê-31">
        </div>
      </div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-bar-inner">
        <div class="progress-bar-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">–û—Ç–≤–µ—á–µ–Ω–æ: 0 –∏–∑ 0</div>
    </div>
    
    <div class="submit-section">
      <button class="submit-btn" onclick="submitTest()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>
    
    <div id="questions-container"></div>
    
    <div class="submit-section">
      <button class="submit-btn" onclick="submitTest()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>
  </div>
  
  <div class="result-block" id="result-block">
    <div class="result-score" id="result-score"></div>
    <div class="result-correct" id="result-correct"></div>
    <div class="result-grade" id="result-grade"></div>
    <div class="result-status" id="result-status"></div>
    <button class="retry-btn" onclick="location.reload()">–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
  </div>
</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6qYwYFUTLpx_tGi-ZH2UahGgHC4CqI4f4yQ5K4FBsZfXZLqLu9mHGDFXrkb3Xu_18rA/exec';
const TEACHER_PASSWORD = '1945';

let testData = null;
let questions = [];
let answers = {};
let startTime = null;
let showAnswersMode = false;
let serverResults = null;

function getTestIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('test') || 'Tema1';
}

async function loadTest() {
  const testId = getTestIdFromUrl();
  
  try {
    const response = await fetch(`${APPS_SCRIPT_URL}?mode=getQuestions&testId=${testId}`);
    const data = await response.json();
    
    if (data.error) {
      document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
      return;
    }
    
    testData = data.config;
    questions = data.questions;
    
    document.getElementById('test-title').textContent = testData.title;
    document.getElementById('test-description').textContent = testData.description;
    
    renderQuestions();
    updateProgress();
    
    document.getElementById('loading').style.display = 'none';
    document.getElementById('test-container').style.display = 'block';
    
    startTime = Date.now();
    
  } catch(error) {
    document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + error.message;
  }
}

function renderQuestions() {
  const container = document.getElementById('questions-container');
  container.innerHTML = '';
  
  questions.forEach((q, index) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.id = `q-${q.id}`;
    
    let questionHtml = `
      <div class="question-header">
        <span class="question-number">–í–æ–ø—Ä–æ—Å ${index + 1}</span>
        <span class="question-weight">${q.weight} ${q.weight === 1 ? '–±–∞–ª–ª' : '–±–∞–ª–ª–∞'}</span>
      </div>
      <div class="question-text">${q.text}</div>
    `;
    
    if (q.type === 'single') {
      questionHtml += renderSingle(q);
    } else if (q.type === 'multi') {
      questionHtml += renderMulti(q);
    } else if (q.type === 'truefalse') {
      questionHtml += renderTrueFalse(q);
    } else if (q.type === 'matching') {
      questionHtml += renderMatching(q);
    } else if (q.type === 'ordering') {
      questionHtml += renderOrdering(q);
    } else if (q.type === 'fillin') {
      questionHtml += renderFillIn(q);
    } else if (q.type === 'numeric') {
      questionHtml += renderNumeric(q);
    } else if (q.type === 'essay') {
      questionHtml += renderEssay(q);
    }
    
    card.innerHTML = questionHtml;
    container.appendChild(card);
  });
}

function renderSingle(q) {
  let html = '<div class="options">';
  q.options.forEach((opt, idx) => {
    html += `
      <label class="option" onclick="selectSingle('${q.id}', ${idx})">
        <input type="radio" name="q-${q.id}" value="${idx}" onchange="updateProgress()">
        <span class="option-text">${opt}</span>
      </label>
    `;
  });
  html += '</div>';
  return html;
}

function renderMulti(q) {
  let html = '<div class="options">';
  q.options.forEach((opt, idx) => {
    html += `
      <label class="option" onclick="toggleMulti('${q.id}', ${idx})">
        <input type="checkbox" class="q-${q.id}" value="${idx}" onchange="updateProgress()">
        <span class="option-text">${opt}</span>
      </label>
    `;
  });
  html += '</div>';
  return html;
}

function renderTrueFalse(q) {
  return `
    <div class="options">
      <label class="option" onclick="selectSingle('${q.id}', 'true')">
        <input type="radio" name="q-${q.id}" value="true" onchange="updateProgress()">
        <span class="option-text">–í–µ—Ä–Ω–æ</span>
      </label>
      <label class="option" onclick="selectSingle('${q.id}', 'false')">
        <input type="radio" name="q-${q.id}" value="false" onchange="updateProgress()">
        <span class="option-text">–ù–µ–≤–µ—Ä–Ω–æ</span>
      </label>
    </div>
  `;
}

function renderMatching(q) {
  const rightOptions = q.shuffleRight ? shuffle([...q.pairs.map(p => p.right)]) : q.pairs.map(p => p.right);
  
  let html = '<div class="matching-container">';
  q.pairs.forEach((pair, idx) => {
    html += `
      <div class="matching-pair">
        <div class="matching-left">${pair.left}</div>
        <div class="matching-right">
          <select onchange="saveMatching('${q.id}', '${pair.left}', this.value); updateProgress()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
            ${rightOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
          </select>
        </div>
      </div>
    `;
  });
  html += '</div>';
  return html;
}

function renderOrdering(q) {
  let html = `<div class="ordering-container" id="ordering-${q.id}">`;
  q.items.forEach((item, idx) => {
    html += `
      <div class="ordering-item" draggable="true" data-index="${idx}">
        <span class="drag-handle">‚ò∞</span>
        <span>${item}</span>
      </div>
    `;
  });
  html += '</div>';
  
  setTimeout(() => {
    setupDragDrop(q.id);
  }, 0);
  
  return html;
}

function renderFillIn(q) {
  let template = q.template;
  for (let i = 0; i < q.blanksCount; i++) {
    template = template.replace('[BLANK]', `<input type="text" class="fillin-input" data-qid="${q.id}" data-blank="${i}" onchange="saveFillIn('${q.id}'); updateProgress()">`);
  }
  return `<div class="fillin-template">${template}</div>`;
}

function renderNumeric(q) {
  return `
    <div class="numeric-input-container">
      <input type="number" step="any" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ" onchange="saveNumeric('${q.id}', this.value); updateProgress()">
      <span class="numeric-unit">${q.unit}</span>
    </div>
  `;
}

function renderEssay(q) {
  return `
    <textarea class="essay-textarea" maxlength="${q.maxLength}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç..." oninput="saveEssay('${q.id}', this.value); updateCharCount('${q.id}', this.value.length, ${q.maxLength}); updateProgress()"></textarea>
    <div class="char-counter" id="char-count-${q.id}">0 / ${q.maxLength}</div>
    ${q.rubric ? `<div style="margin-top:10px; font-size:13px; color:#666;">–ö—Ä–∏—Ç–µ—Ä–∏–∏: ${q.rubric}</div>` : ''}
  `;
}

function selectSingle(qid, value) {
  answers[qid] = value;
}

function toggleMulti(qid, value) {
  setTimeout(() => {
    const checked = Array.from(document.querySelectorAll(`.q-${qid}:checked`)).map(cb => parseInt(cb.value));
    answers[qid] = checked.length > 0 ? checked : undefined;
  }, 0);
}

function saveMatching(qid, left, right) {
  if (!answers[qid]) answers[qid] = {};
  answers[qid][left] = right;
}

function setupDragDrop(qid) {
  const container = document.getElementById(`ordering-${qid}`);
  const items = container.querySelectorAll('.ordering-item');
  
  let draggedItem = null;
  
  items.forEach(item => {
    item.addEventListener('dragstart', function() {
      draggedItem = this;
      setTimeout(() => this.style.opacity = '0.5', 0);
    });
    
    item.addEventListener('dragend', function() {
      setTimeout(() => this.style.opacity = '1', 0);
      draggedItem = null;
      saveOrdering(qid);
      updateProgress();
    });
    
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
    });
    
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      if (draggedItem !== this) {
        const allItems = [...container.querySelectorAll('.ordering-item')];
        const draggedIndex = allItems.indexOf(draggedItem);
        const targetIndex = allItems.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedItem, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedItem, this);
        }
      }
    });
  });
}

function saveOrdering(qid) {
  const container = document.getElementById(`ordering-${qid}`);
  const items = container.querySelectorAll('.ordering-item');
  const order = Array.from(items).map(item => parseInt(item.dataset.index));
  answers[qid] = order;
}

function saveFillIn(qid) {
  const inputs = document.querySelectorAll(`input[data-qid="${qid}"]`);
  const blanks = Array.from(inputs).map(inp => inp.value.trim());
  answers[qid] = blanks.some(b => b !== '') ? blanks : undefined;
}

function saveNumeric(qid, value) {
  answers[qid] = value !== '' ? value : undefined;
}

function saveEssay(qid, value) {
  answers[qid] = value.trim() !== '' ? value.trim() : undefined;
}

function updateCharCount(qid, length, max) {
  document.getElementById(`char-count-${qid}`).textContent = `${length} / ${max}`;
}

function updateProgress() {
  const answered = Object.keys(answers).filter(k => answers[k] !== undefined && answers[k] !== '').length;
  const total = questions.length;
  const percent = total > 0 ? (answered / total) * 100 : 0;
  
  document.getElementById('progress-fill').style.width = percent + '%';
  document.getElementById('progress-text').textContent = `–û—Ç–≤–µ—á–µ–Ω–æ: ${answered} –∏–∑ ${total}`;
}

function shuffle(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function submitTest() {
  const fio = document.getElementById('student-name').value;
  const group = document.getElementById('student-group').value;
  
  if (!fio) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –§–ò–û –∏–∑ —Å–ø–∏—Å–∫–∞');
    return;
  }
  
  if (!group) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≥—Ä—É–ø–ø—É');
    return;
  }
  
  const duration = Math.floor((Date.now() - startTime) / 1000);
  
  const payload = {
    mode: 'submit',
    testId: testData.testId,
    fio: fio,
    group: group,
    attempt: 1,
    duration: duration,
    answers: answers
  };
  
  try {
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    serverResults = result;
    
    showResults(result);
    
  } catch(error) {
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
  }
}

function showResults(result) {
  document.getElementById('test-container').style.display = 'none';
  
  const resultBlock = document.getElementById('result-block');
  resultBlock.style.display = 'block';
  
  document.getElementById('result-score').textContent = `${result.scoreWeighted.toFixed(1)} / ${result.maxWeight}`;
  document.getElementById('result-correct').textContent = `(–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: ${result.correctCount} –∏–∑ ${result.totalCount})`;
  
  const gradeDiv = document.getElementById('result-grade');
  gradeDiv.textContent = `–û—Ü–µ–Ω–∫–∞: ${result.score10}`;
  gradeDiv.className = 'result-grade grade-' + result.score10;
  
  let statusText = `‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é`;
  if (result.unanswered > 0) {
    statusText += `<br>‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${result.unanswered}`;
  }
  if (result.needsManualGrade) {
    statusText += `<br>üìù –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏`;
  }
  
  document.getElementById('result-status').innerHTML = statusText;
}

function promptPassword() {
  if (showAnswersMode) {
    showAnswersMode = false;
    alert('–†–µ–∂–∏–º –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç–∫–ª—é—á—ë–Ω');
    return;
  }
  
  const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:');
  if (password === TEACHER_PASSWORD) {
    if (serverResults) {
      showAnswersMode = true;
      highlightAnswers();
      alert('–†–µ–∂–∏–º –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤–∫–ª—é—á—ë–Ω');
    } else {
      alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç');
    }
  } else if (password !== null) {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
  }
}

function highlightAnswers() {
  if (!serverResults || !serverResults.details) return;
  
  serverResults.details.forEach(detail => {
    const card = document.getElementById(`q-${detail.qId}`);
    if (!card) return;
    
    const options = card.querySelectorAll('.option');
    options.forEach(opt => {
      const input = opt.querySelector('input');
      if (!input) return;
      
      if (detail.correct) {
        if (input.checked) {
          opt.classList.add('correct');
        }
      } else {
        if (input.checked) {
          opt.classList.add('incorrect');
        }
      }
    });
  });
}

window.addEventListener('load', loadTest);
</script>

</body>
</html>